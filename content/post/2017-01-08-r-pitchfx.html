---
title: "PITCHf/xから見た田中将大投手"
author: "Tsuyupon"
date: "2018-01-08"
categories: ["baseball"]
tags: ["R", "セイバーメトリクス"]
output:
  blogdown::html_page:
    toc: false
---



<p>記念すべき新BLOGの初投稿です！<br />
今回は「PITCHf/xから見た田中将大投手」ということでPITCHf/xシステムを通じて取得したMLBの投球データを使っていろんな角度から田中将大投手を分析したいと思います。</p>
<div id="pitchfx" class="section level2">
<h2>1. PITCHf/xとは？</h2>
<p>PITCHf/xとは、SPORTVISION社が開発した投手の投球速度や投球軌道を追跡するスピード測定器システムです。<br />
マウンドから本塁までの投球の球速、マグヌス効果によって引き起こされる変化の量、リリースポイント、スピン量、本塁上を通過した時にストライクゾーン内に入っているかを知ることが出来ます。</p>
<div class="figure">
<img src="https://user-images.githubusercontent.com/6095476/34592967-33d1c4b8-f20b-11e7-990b-ea4ebddff76d.jpg" />

</div>
<p>引用：<a href="http://www.baseball-lab.jp/column/entry/128/" class="uri">http://www.baseball-lab.jp/column/entry/128/</a></p>
</div>
<div class="section level2">
<h2>2. 田中将大投手の成績について</h2>
<p>以下はマーくんのMLBでの成績です。</p>
<table>
<thead>
<tr class="header">
<th align="left">年</th>
<th align="left">チーム</th>
<th align="right">登板</th>
<th align="right">投球回</th>
<th align="right">完投</th>
<th align="right">自責点</th>
<th align="right">奪三振</th>
<th align="right">勝</th>
<th align="right">敗</th>
<th align="right">セーブ</th>
<th align="right">WHIP</th>
<th align="right">防御率</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">2014</td>
<td align="left">ヤンキース</td>
<td align="right">20</td>
<td align="right">136 1/3</td>
<td align="right">3</td>
<td align="right">42</td>
<td align="right">141</td>
<td align="right">13</td>
<td align="right">5</td>
<td align="right">0</td>
<td align="right">1.06</td>
<td align="right">2.77</td>
</tr>
<tr class="even">
<td align="left">2015</td>
<td align="left">ヤンキース</td>
<td align="right">24</td>
<td align="right">154</td>
<td align="right">1</td>
<td align="right">60</td>
<td align="right">139</td>
<td align="right">12</td>
<td align="right">7</td>
<td align="right">0</td>
<td align="right">0.99</td>
<td align="right">3.51</td>
</tr>
<tr class="odd">
<td align="left">2016</td>
<td align="left">ヤンキース</td>
<td align="right">31</td>
<td align="right">199 2/3</td>
<td align="right">0</td>
<td align="right">68</td>
<td align="right">165</td>
<td align="right">14</td>
<td align="right">4</td>
<td align="right">0</td>
<td align="right">1.08</td>
<td align="right">3.07</td>
</tr>
<tr class="even">
<td align="left">2017</td>
<td align="left">ヤンキース</td>
<td align="right">30</td>
<td align="right">178 1/3</td>
<td align="right">1</td>
<td align="right"><span style="color: red">94</span></td>
<td align="right"><span style="color: blue">194</span></td>
<td align="right">13</td>
<td align="right"><span style="color: red">12</span></td>
<td align="right">0</td>
<td align="right">1.24</td>
<td align="right">4.74</td>
</tr>
<tr class="odd">
<td align="left">通算</td>
<td align="left"></td>
<td align="right">105</td>
<td align="right">668 1/3</td>
<td align="right">5</td>
<td align="right">264</td>
<td align="right">639</td>
<td align="right">52</td>
<td align="right">28</td>
<td align="right">0</td>
<td align="right">1.10</td>
<td align="right">3.56</td>
</tr>
</tbody>
</table>
<p>2017年は、奪三振数と勝ち数が多かったものの自責点と負け数も多く、結果としてWHIP(Walks plus Hits per Inning Pitched、「投球回あたり与四球・被安打数合計」)の値が高くなってしまいました。</p>
<div class="kome">
<p>※ WHIP = (与四球 + 被安打) ÷ 投球回<br />
1回に平均何人のランナーを出しているかという指標。一般に先発投手であれば1.00未満なら球界を代表するエースとされ、1.20未満ならエース級、逆に1.40を上回ると問題であると言われる。</p>
</div>
<p>これは調子、配球、球速、コントロールなどいったい何が要因だったのでしょうか。<br />
さっそくPITCHf/xのデータを使って見ていきましょう。</p>
</div>
<div class="section level2">
<h2>3. データの取得</h2>
<p>まずPITCHf/xのデータの取得方法についてです。元データは<a href="http://gd2.mlb.com/components/" class="uri">http://gd2.mlb.com/components/</a>にXML形式で置かれています。今回はRからこのデータをスクレイピングしてデータベースに格納してみます。</p>
<p>Rには既に<code>{pitchRx}</code>パッケージというまさにこれ専用の便利なパッケージがあります。ただ使い勝手が少々悪かったので自分用に少々手を加えました。</p>
<iframe class="hatenablogcard" src="https://hatenablog-parts.com/embed?url=https://github.com/pontsuyu/pitchRx2" width="300" height="150" frameborder="0" scrolling="no">
</iframe>
<p>※<code>{pitchRx}</code>パッケージの基本的な使い方は<a href="https://pitchrx.cpsievert.me/">コチラ</a>を参照。<br />
<code>{pitchRx2}</code>パッケージでも可視化以外は同じ関数名で使えます。</p>
<p><code>{pitchRx}</code>パッケージではスクレイピングする際、初めと終わりの日付を指定するか、gameidを指定するのですが、大抵必要なデータはその中の一部で、全試合欲しい場合はほとんどないと思います。<code>{pitchRx2}</code>パッケージでは<code>get_gids()</code>というgameidの一覧を取得する関数を追加しました。start_yearとend_yearを指定すれば、その年の全てのgameidを取得することが出来ます(<code>pitxhRx2::game_ids</code>にすでに2017年までのgameidデータが入ってるので、ご活用ください)。この関数を実行した後、<code>stringr::str_detect()</code>などで日付やチームを絞ってから<code>scrape()</code>を実行するのが、効率的かと思います。</p>
<p><code>{pitchRx2}</code>パッケージはまだまだ改良の余地があるので要望があれば、<a href="https://twitter.com/ponsa__ku">twitter</a>でご連絡いただくか、Githubの<a href="https://github.com/pontsuyu/pitchRx2/issues">Issues</a>に書き込むなりしていただければと思います。</p>
<pre class="r"><code># devtools::install_github(&quot;pontsuyu/pitchRx2&quot;)
library(pitchRx2)
library(xml2)
library(DBI)
library(tidyverse)</code></pre>
<pre><code>## ─ Attaching packages ──────────────── tidyverse 1.2.1 ─</code></pre>
<pre><code>## ✔ ggplot2 2.2.1     ✔ purrr   0.2.4
## ✔ tibble  1.3.4     ✔ dplyr   0.7.4
## ✔ tidyr   0.7.2     ✔ stringr 1.2.0
## ✔ readr   1.1.1     ✔ forcats 0.2.0</code></pre>
<pre><code>## ─ Conflicts ────────────────── tidyverse_conflicts() ─
## ✖ dplyr::filter() masks stats::filter()
## ✖ dplyr::lag()    masks stats::lag()</code></pre>
<pre class="r"><code># 2008〜2017年のgameidはあらかじめ用意してあるgame_idsをお使いください
# ヤンキースのデータに絞ります
nya &lt;- game_ids %&gt;% str_subset(&quot;201[4-7].*nya.*&quot;)
# スクレイピングしたデータの格納先を準備
db &lt;- src_sqlite(&quot;nya.sqlite3&quot;, create = T)
# スクレイピングの実行
scrape(game.ids = nya, connect = db$con, suffix = &quot;inning/inning_all.xml&quot;)
# テーブルを確認
db_list_tables(db$con)
# &quot;action&quot; &quot;atbat&quot; &quot;pitch&quot; &quot;po&quot; &quot;runner&quot;</code></pre>
</div>
<div class="section level2">
<h2>3. 球種割合</h2>
<p>1球データをデータベースに格納できたのでクエリを実行し、データを抽出、分析します。</p>
<pre class="r"><code># 2回目以降はこちらを実行
db &lt;- src_sqlite(&quot;nya.sqlite3&quot;, create = F)
# データの抽出
dat &lt;- dbGetQuery(db$con, &quot;SELECT
                  pitcher_name, -- 投手名
                  p_throws, -- 投手の利き腕
                  batter_name, -- 打者名
                  stand, -- 打者の立ち位置
                  pitch_type, -- 球種
                  start_speed, -- 初速
                  end_speed, -- 終速
                  spin_rate, -- 回転数
                  spin_dir, -- 回転軸
                  px, pz, -- 投球ロケーション
                  x0, y0, z0,
                  vx0, vy0, vz0, -- 速度
                  ax, ay, az, -- 加速度
                  b_height,
                  break_angle, -- 変化角
                  break_length, -- 変化量
                  pit.num as event_num,
                  pit.des, -- 投球結果
                  type,
                  event,
                  atb.date -- 日時
                  FROM
                  atbat atb, -- 打席テーブル
                  pitch pit -- 投球データテーブル
                  WHERE atb.url = pit.url -- スクレイピング先url
                  AND atb.inning = pit.inning -- イニング
                  AND atb.inning_side = pit.inning_side -- 表/裏
                  AND atb.gameday_link = pit.gameday_link -- gameid
                  AND atb.next_ = pit.next_ -- 次打者の有無
                  AND atb.num = pit.num -- イベント番号
                  -- キャンプ/プレーオフのデータは除外する処理
                  AND ((CAST(REPLACE(atb.date, &#39;_&#39;, &#39;&#39;) as NUMBER)  BETWEEN 20140322 AND 20160928)
                  OR   (CAST(REPLACE(atb.date, &#39;_&#39;, &#39;&#39;) as NUMBER) BETWEEN 20150406 AND 20151004)
                  OR   (CAST(REPLACE(atb.date, &#39;_&#39;, &#39;&#39;) as NUMBER) BETWEEN 20160403 AND 20161002)
                  OR   (CAST(REPLACE(atb.date, &#39;_&#39;, &#39;&#39;) as NUMBER) BETWEEN 20170402 AND 20171001))
                  AND atb.pitcher_name is not null
                  AND pit.pitch_type is not null
                  ;&quot;)
# sort(unique(dat$pitcher_name))
# 見たいピッチャーの名前を入力
p_name &lt;- &quot;Masahiro Tanaka&quot;
pitch &lt;- dat %&gt;% 
         filter(pitcher_name==p_name) %&gt;% 
         separate(date, c(&quot;year&quot;, &quot;month&quot;, &quot;day&quot;), sep = &quot;_&quot;)
# 打者の立ち位置別球種割合を算出
pt &lt;- pitch %&gt;% 
      group_by(year, stand, pitch_type) %&gt;% 
      summarise(N = n()) %&gt;% 
      group_by(year, stand) %&gt;% 
      mutate(per = N/sum(N)*100) %&gt;% 
      inner_join(pitch_type, by = &quot;pitch_type&quot;) %&gt;% # 球種名称を紐付ける
      arrange(year, pitch_type_name) %&gt;% 
      mutate(row = row_number()) %&gt;% # ここから下はグラフ用の処理
      arrange(desc(row)) %&gt;% 
      group_by(year, stand) %&gt;% 
      mutate(cumsum = cumsum(per) - 0.5*per,
             year_N = paste0(stand, &quot;_&quot;, year, &quot;(N=&quot;, sum(N), &quot;)&quot;)) %&gt;% 
      ungroup() %&gt;%
      as.data.frame

ggplot(pt, aes(year_N, per, fill = pitch_type_name)) + 
  geom_bar(stat = &quot;identity&quot;) +
  geom_text(aes(label = round(per,digits = 2), y = cumsum), size = 3) +
  xlab(&quot;stand_year_pitching-N&quot;) + ylab(&quot;percent&quot;) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))</code></pre>
<p><img src="/post/2017-01-08-r-pitchfx_files/figure-html/unnamed-chunk-3-1.png" width="672" /></p>
<p>捕手のリードの影響もありますが、当然右打者と左打者で攻め方が違って見えます。球種割合については、2014年のヒジの故障が影響しているせいか2015年以降Sliderの割合が増えて、その分Fastballの割合が下がっているようです。</p>
</div>
<div class="section level2">
<h2>4. 球速・緩急</h2>
<p>打たれないようにするには球種だけでなく、球速・緩急も大事になってきます。</p>
<pre class="r"><code>library(animation)
x &lt;- list(facet_grid(stand ~ year, labeller = label_both), coord_equal())
# アニメーションにして出力
saveGIF({animateFX(pitch, layers = x, point.alpha = 0.3)},
        interval = 0.01, movie.name = paste0(p_name, &quot;.gif&quot;))</code></pre>
<pre><code>## Warning: Removed 1 rows containing missing values (geom_point).

## Warning: Removed 1 rows containing missing values (geom_point).</code></pre>
<pre><code>## Warning: Removed 4 rows containing missing values (geom_point).</code></pre>
<pre><code>## Warning: Removed 10 rows containing missing values (geom_point).</code></pre>
<pre><code>## Warning: Removed 21 rows containing missing values (geom_point).</code></pre>
<pre><code>## Warning: Removed 40 rows containing missing values (geom_point).</code></pre>
<pre><code>## Warning: Removed 76 rows containing missing values (geom_point).</code></pre>
<pre><code>## Warning: Removed 127 rows containing missing values (geom_point).</code></pre>
<pre><code>## Warning: Removed 158 rows containing missing values (geom_point).</code></pre>
<pre><code>## Warning: Removed 163 rows containing missing values (geom_point).</code></pre>
<pre><code>## Warning: Removed 167 rows containing missing values (geom_point).

## Warning: Removed 167 rows containing missing values (geom_point).</code></pre>
<pre><code>## Warning: Removed 171 rows containing missing values (geom_point).</code></pre>
<pre><code>## Warning: Removed 172 rows containing missing values (geom_point).</code></pre>
<pre><code>## Warning: Removed 173 rows containing missing values (geom_point).

## Warning: Removed 173 rows containing missing values (geom_point).

## Warning: Removed 173 rows containing missing values (geom_point).

## Warning: Removed 173 rows containing missing values (geom_point).</code></pre>
<pre><code>## Executing: 
## convert -loop 0 -delay 1 Rplot1.png Rplot2.png Rplot3.png
##     Rplot4.png Rplot5.png Rplot6.png Rplot7.png Rplot8.png
##     Rplot9.png Rplot10.png Rplot11.png Rplot12.png Rplot13.png
##     Rplot14.png Rplot15.png Rplot16.png Rplot17.png Rplot18.png
##     Rplot19.png Rplot20.png Rplot21.png Rplot22.png Rplot23.png
##     Rplot24.png Rplot25.png Rplot26.png Rplot27.png Rplot28.png
##     Rplot29.png Rplot30.png Rplot31.png Rplot32.png Rplot33.png
##     Rplot34.png Rplot35.png Rplot36.png Rplot37.png Rplot38.png
##     Rplot39.png Rplot40.png Rplot41.png Rplot42.png Rplot43.png
##     Rplot44.png Rplot45.png Rplot46.png Rplot47.png Rplot48.png
##     Rplot49.png Rplot50.png &#39;Masahiro Tanaka.gif&#39;</code></pre>
<pre><code>## Output at: Masahiro Tanaka.gif</code></pre>
<pre><code>## [1] TRUE</code></pre>
<div class="figure">
<img src="https://user-images.githubusercontent.com/6095476/34660601-ea8b69ac-f486-11e7-994b-2153a649b692.gif" />

</div>
</div>
<div class="section level2">
<h2>対打席結果のまとめ</h2>
<pre><code>- 2017年は被本塁打率の高いことを言及したい</code></pre>
</div>
<div class="section level2">
<h2>使用球種の比率のまとめ</h2>
<pre><code>- ストレート率が低く、SFF率が高いことを言及
- リリースポイントに対するブレを言及
- どの球種が打たれているのかをまとめる</code></pre>
</div>
<div class="section level2">
<h2>緩急、キレ、ノビの分析</h2>
</div>
<div class="section level2">
<h2>つづく</h2>
</div>
